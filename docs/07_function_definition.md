# 機能定義

## 概要

このドキュメントは、mcpax の機能を定義する。
UI 定義（06_ui_definition.md）で定義した各コマンドを実現するために必要な機能を整理した。

---

## 機能一覧

### 設定管理機能

| ID | 機能名 | 説明 |
|----|--------|------|
| F-101 | 設定ファイル生成 | config.toml を生成する |
| F-102 | 設定ファイル読み込み | config.toml を読み込む |
| F-103 | プロジェクトリスト生成 | projects.toml を生成する |
| F-104 | プロジェクトリスト読み込み | projects.toml を読み込む |
| F-105 | プロジェクトリスト書き込み | projects.toml を更新する |
| F-106 | パス解決 | ~ や相対パスを絶対パスに展開する |
| F-107 | 設定バリデーション | 設定値の妥当性を検証する |

### Modrinth API 連携機能

| ID | 機能名 | 説明 |
|----|--------|------|
| F-201 | プロジェクト情報取得 | slug からプロジェクト情報を取得する |
| F-202 | プロジェクト検索 | キーワードでプロジェクトを検索する |
| F-203 | バージョン一覧取得 | プロジェクトのバージョン一覧を取得する |
| F-204 | 対応バージョン抽出 | MC バージョン・Loader に対応するバージョンを抽出する |
| F-205 | レートリミット制御 | API のレートリミットを遵守する |
| F-206 | リトライ処理 | 一時的なエラー時にリトライする |

### ダウンロード機能

| ID | 機能名 | 説明 |
|----|--------|------|
| F-301 | ファイルダウンロード | URL からファイルをダウンロードする |
| F-302 | 並列ダウンロード | 複数ファイルを並列でダウンロードする |
| F-303 | ハッシュ検証 | ダウンロードしたファイルの SHA512 を検証する |
| F-304 | 進捗表示 | ダウンロードの進捗を表示する |

### ファイル管理機能

| ID | 機能名 | 説明 |
|----|--------|------|
| F-401 | ディレクトリ判定 | プロジェクト種別から配置先ディレクトリを判定する |
| F-402 | ファイル配置 | ダウンロードしたファイルを適切なディレクトリに配置する |
| F-403 | ファイルバックアップ | 更新前のファイルをバックアップする |
| F-404 | ファイル削除 | 指定したファイルを削除する |
| F-405 | インストール状態確認 | プロジェクトがインストール済みか確認する |
| F-406 | インストールファイル特定 | slug からインストール済みファイルを特定する |

### 更新管理機能

| ID | 機能名 | 説明 |
|----|--------|------|
| F-501 | 更新確認 | 各プロジェクトの更新有無を確認する |
| F-502 | バージョン比較 | ローカルとリモートのバージョンを比較する |
| F-503 | 更新適用 | 更新があるプロジェクトをダウンロード・配置する |

---

## 機能詳細

### F-101: 設定ファイル生成

config.toml を生成する。

#### 入力

| パラメータ | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| minecraft_version | str | ✓ | Minecraft バージョン |
| loader | Loader | ✓ | Mod Loader |
| minecraft_dir | Path | ✓ | Minecraft ディレクトリ |
| force | bool | - | 上書きを許可するか |

#### 出力

| 型 | 説明 |
|----|------|
| Path | 生成したファイルのパス |

#### 例外

| 例外 | 条件 |
|------|------|
| FileExistsError | ファイルが既存かつ force=False |

#### 生成されるファイル

```toml
[minecraft]
version = "1.21.4"
loader = "fabric"

[paths]
minecraft_dir = "~/.minecraft"
```

---

### F-102: 設定ファイル読み込み

config.toml を読み込み、AppConfig オブジェクトを返す。

#### 入力

| パラメータ | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| path | Path | - | ファイルパス（省略時はカレントディレクトリ） |

#### 出力

| 型 | 説明 |
|----|------|
| AppConfig | 設定オブジェクト |

#### 例外

| 例外 | 条件 |
|------|------|
| FileNotFoundError | ファイルが存在しない |
| ConfigValidationError | 設定値が不正 |

---

### F-103: プロジェクトリスト生成

空の projects.toml を生成する。

#### 入力

| パラメータ | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| path | Path | - | ファイルパス |
| force | bool | - | 上書きを許可するか |

#### 出力

| 型 | 説明 |
|----|------|
| Path | 生成したファイルのパス |

#### 生成されるファイル

```toml
# mcpax - Project List
# Add projects with: mcpax add <slug>
```

---

### F-104: プロジェクトリスト読み込み

projects.toml を読み込み、ProjectConfig のリストを返す。

#### 入力

| パラメータ | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| path | Path | - | ファイルパス |

#### 出力

| 型 | 説明 |
|----|------|
| list[ProjectConfig] | プロジェクト設定のリスト |

#### 例外

| 例外 | 条件 |
|------|------|
| FileNotFoundError | ファイルが存在しない |

---

### F-105: プロジェクトリスト書き込み

ProjectConfig のリストを projects.toml に書き込む。

#### 入力

| パラメータ | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| projects | list[ProjectConfig] | ✓ | プロジェクト設定のリスト |
| path | Path | - | ファイルパス |

#### 出力

| 型 | 説明 |
|----|------|
| Path | 書き込んだファイルのパス |

---

### F-106: パス解決

~ や相対パスを絶対パスに展開する。

#### 入力

| パラメータ | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| path | str \| Path | ✓ | パス文字列 |

#### 出力

| 型 | 説明 |
|----|------|
| Path | 絶対パス |

#### 処理

1. `~` を `$HOME` に展開
2. 相対パスを絶対パスに変換

---

### F-107: 設定バリデーション

設定値の妥当性を検証する。

#### 入力

| パラメータ | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| config | AppConfig | ✓ | 設定オブジェクト |

#### 出力

| 型 | 説明 |
|----|------|
| list[ValidationError] | 検証エラーのリスト（空ならOK） |

#### 検証項目

| 項目 | 検証内容 |
|------|---------|
| minecraft_version | 形式が正しいか（例: 1.21.4） |
| loader | 有効な値か（fabric/forge/neoforge/quilt） |
| minecraft_dir | ディレクトリが存在するか |

---

### F-201: プロジェクト情報取得

slug からプロジェクト情報を取得する。

#### 入力

| パラメータ | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| slug | str | ✓ | プロジェクト slug |

#### 出力

| 型 | 説明 |
|----|------|
| ModrinthProject | プロジェクト情報 |

#### 例外

| 例外 | 条件 |
|------|------|
| ProjectNotFoundError | プロジェクトが存在しない |
| APIError | API エラー |

#### API エンドポイント

```
GET /project/{slug}
```

---

### F-202: プロジェクト検索

キーワードでプロジェクトを検索する。

#### 入力

| パラメータ | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| query | str | ✓ | 検索キーワード |
| facets | list[list[str]] | - | フィルタ条件 |
| limit | int | - | 取得件数（デフォルト: 10） |
| offset | int | - | オフセット |

#### 出力

| 型 | 説明 |
|----|------|
| list[ModrinthProject] | 検索結果 |

#### API エンドポイント

```
GET /search?query={query}&facets={facets}&limit={limit}&offset={offset}
```

---

### F-203: バージョン一覧取得

プロジェクトのバージョン一覧を取得する。

#### 入力

| パラメータ | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| slug | str | ✓ | プロジェクト slug |
| game_versions | list[str] | - | MC バージョンでフィルタ |
| loaders | list[str] | - | Loader でフィルタ |

#### 出力

| 型 | 説明 |
|----|------|
| list[ProjectVersion] | バージョン一覧 |

#### API エンドポイント

```
GET /project/{slug}/version?game_versions={versions}&loaders={loaders}
```

---

### F-204: 対応バージョン抽出

バージョン一覧から MC バージョン・Loader に対応するものを抽出する。

#### 入力

| パラメータ | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| versions | list[ProjectVersion] | ✓ | バージョン一覧 |
| minecraft_version | str | ✓ | MC バージョン |
| loader | Loader | - | Loader（MOD の場合のみ） |
| channel | ReleaseChannel | - | リリースチャネル |

#### 出力

| 型 | 説明 |
|----|------|
| ProjectVersion \| None | 最適なバージョン（なければ None） |

#### 抽出ロジック

1. game_versions に minecraft_version を含むものを抽出
2. MOD の場合、loaders に loader を含むものを抽出
3. version_type が channel 以上のものを抽出
4. 日付が最新のものを選択

---

### F-205: レートリミット制御

API のレートリミットを遵守する。

#### 処理

1. レスポンスヘッダから残りリクエスト数を取得
   - `X-Ratelimit-Remaining`
2. 残りが少ない場合、リセット時刻まで待機
   - `X-Ratelimit-Reset`

---

### F-206: リトライ処理

一時的なエラー時にリトライする。

#### 入力

| パラメータ | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| max_retries | int | - | 最大リトライ回数（デフォルト: 3） |
| backoff_factor | float | - | バックオフ係数（デフォルト: 1.0） |

#### 処理

1. リクエスト実行
2. 5xx エラーまたはタイムアウトの場合、リトライ
3. 待機時間: `backoff_factor * (2 ** retry_count)`

---

### F-301: ファイルダウンロード

URL からファイルをダウンロードする。

#### 入力

| パラメータ | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| url | str | ✓ | ダウンロード URL |
| dest | Path | ✓ | 保存先パス |
| expected_hash | str | - | 期待する SHA512 ハッシュ |

#### 出力

| 型 | 説明 |
|----|------|
| Path | ダウンロードしたファイルのパス |

#### 例外

| 例外 | 条件 |
|------|------|
| DownloadError | ダウンロード失敗 |
| HashMismatchError | ハッシュ不一致 |

---

### F-302: 並列ダウンロード

複数ファイルを並列でダウンロードする。

#### 入力

| パラメータ | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| files | list[DownloadTask] | ✓ | ダウンロードタスクのリスト |
| max_concurrent | int | - | 最大並列数（デフォルト: 5） |
| progress_callback | Callable | - | 進捗コールバック |

#### 出力

| 型 | 説明 |
|----|------|
| list[DownloadResult] | ダウンロード結果のリスト |

---

### F-303: ハッシュ検証

ダウンロードしたファイルの SHA512 を検証する。

#### 入力

| パラメータ | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| file_path | Path | ✓ | ファイルパス |
| expected_hash | str | ✓ | 期待する SHA512 ハッシュ |

#### 出力

| 型 | 説明 |
|----|------|
| bool | 一致すれば True |

---

### F-304: 進捗表示

ダウンロードの進捗を表示する。

#### 入力

| パラメータ | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| total | int | ✓ | 全体のバイト数 |
| downloaded | int | ✓ | ダウンロード済みバイト数 |
| filename | str | ✓ | ファイル名 |

#### 表示形式

```
[████████████████████] sodium 0.6.0 (2.5 MB / 3.2 MB)
```

---

### F-401: ディレクトリ判定

プロジェクト種別から配置先ディレクトリを判定する。

#### 入力

| パラメータ | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| project_type | ProjectType | ✓ | プロジェクト種別 |
| config | AppConfig | ✓ | 設定 |

#### 出力

| 型 | 説明 |
|----|------|
| Path | 配置先ディレクトリ |

#### マッピング

| project_type | ディレクトリ |
|--------------|-------------|
| mod | {minecraft_dir}/mods |
| shader | {minecraft_dir}/shaderpacks |
| resourcepack | {minecraft_dir}/resourcepacks |

---

### F-402: ファイル配置

ダウンロードしたファイルを適切なディレクトリに配置する。

#### 入力

| パラメータ | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| src | Path | ✓ | ソースファイル |
| dest_dir | Path | ✓ | 配置先ディレクトリ |

#### 出力

| 型 | 説明 |
|----|------|
| Path | 配置したファイルのパス |

#### 処理

1. 配置先ディレクトリが存在しなければ作成
2. ファイルを移動

---

### F-403: ファイルバックアップ

更新前のファイルをバックアップする。

#### 入力

| パラメータ | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| file_path | Path | ✓ | バックアップ対象ファイル |
| backup_dir | Path | - | バックアップ先（デフォルト: .mcpax-backup） |

#### 出力

| 型 | 説明 |
|----|------|
| Path | バックアップファイルのパス |

#### 処理

1. バックアップディレクトリが存在しなければ作成
2. タイムスタンプ付きでコピー

---

### F-404: ファイル削除

指定したファイルを削除する。

#### 入力

| パラメータ | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| file_path | Path | ✓ | 削除対象ファイル |

#### 出力

| 型 | 説明 |
|----|------|
| bool | 削除成功なら True |

---

### F-405: インストール状態確認

プロジェクトがインストール済みか確認する。

#### 入力

| パラメータ | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| slug | str | ✓ | プロジェクト slug |
| config | AppConfig | ✓ | 設定 |

#### 出力

| 型 | 説明 |
|----|------|
| InstallStatus | インストール状態 |

#### InstallStatus

```python
class InstallStatus(Enum):
    NOT_INSTALLED = "not_installed"
    INSTALLED = "installed"
    OUTDATED = "outdated"
    NOT_COMPATIBLE = "not_compatible"
```

---

### F-406: インストールファイル特定

slug からインストール済みファイルを特定する。

#### 入力

| パラメータ | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| slug | str | ✓ | プロジェクト slug |
| config | AppConfig | ✓ | 設定 |

#### 出力

| 型 | 説明 |
|----|------|
| InstalledFile \| None | インストール済みファイル情報 |

#### 処理

1. 状態管理ファイル（.mcpax-state.json）を読み込む
2. slug に対応するファイル情報を返す

---

### F-501: 更新確認

各プロジェクトの更新有無を確認する。

#### 入力

| パラメータ | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| projects | list[ProjectConfig] | ✓ | プロジェクト設定リスト |
| config | AppConfig | ✓ | 設定 |

#### 出力

| 型 | 説明 |
|----|------|
| list[UpdateCheckResult] | 更新確認結果 |

#### UpdateCheckResult

```python
@dataclass
class UpdateCheckResult:
    slug: str
    status: InstallStatus
    current_version: str | None
    latest_version: str | None
    latest_file: ProjectFile | None
```

---

### F-502: バージョン比較

ローカルとリモートのバージョンを比較する。

#### 入力

| パラメータ | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| installed | InstalledFile | ✓ | インストール済みファイル |
| latest | ProjectVersion | ✓ | 最新バージョン |

#### 出力

| 型 | 説明 |
|----|------|
| bool | 更新が必要なら True |

#### 処理

1. インストール済みファイルのハッシュと最新ファイルのハッシュを比較
2. 異なれば更新が必要

---

### F-503: 更新適用

更新があるプロジェクトをダウンロード・配置する。

#### 入力

| パラメータ | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| updates | list[UpdateCheckResult] | ✓ | 更新対象リスト |
| config | AppConfig | ✓ | 設定 |
| backup | bool | - | バックアップするか（デフォルト: True） |

#### 出力

| 型 | 説明 |
|----|------|
| UpdateResult | 更新結果 |

#### 処理

1. 更新対象のファイルをダウンロード
2. ハッシュ検証
3. 古いファイルをバックアップ（backup=True の場合）
4. 新しいファイルを配置
5. 状態管理ファイルを更新

---

## 機能とコマンドの対応表

| コマンド | 使用する機能 |
|---------|-------------|
| mcpax init | F-101, F-103 |
| mcpax add | F-102, F-104, F-105, F-201 |
| mcpax remove | F-102, F-104, F-105, F-404, F-406 |
| mcpax list | F-102, F-104, F-405 |
| mcpax search | F-102, F-202 |
| mcpax update | F-102, F-104, F-501, F-502, F-503, F-301, F-302, F-303, F-403, F-402 |
| mcpax install | F-102, F-104, F-201, F-203, F-204, F-301, F-302, F-303, F-402, F-401 |
